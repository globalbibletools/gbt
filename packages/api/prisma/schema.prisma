// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  output          = "./client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // pgcrypto is necessary for ULIDs which are better than random UUIDs.
  extensions = [pgcrypto]
}

enum EmailStatus {
  UNVERIFIED
  VERIFIED
  BOUNCED
  COMPLAINED
}

/// A user who can authenticate into the system.
model AuthUser {
  /// The ID of the user.
  id            String               @id @default(dbgenerated("generate_ulid()")) @db.Uuid
  /// The display name of the user.
  name          String?
  /// The email address for logging in and notifications.
  email         String?              @unique
  /// The status of the email (whether we can send emails or not).
  emailStatus   EmailStatus          @default(UNVERIFIED)
  /// The list of system roles this user has
  systemRoles   UserSystemRole[]
  /// The list of sessions for the user.
  auth_session  AuthSession[]
  /// The list of auth keys for the user
  auth_key      AuthKey[]
  /// The roles for this user on all languages.
  languageRoles LanguageMemberRole[]

  @@map("User")
}

/// A authenticated session for a user.
model AuthSession {
  /// The ID of the session as stored in the cookie.
  id             String   @id @unique
  /// The id of the authenticated user
  user_id        String   @db.Uuid
  /// The time that the session will expire.
  active_expires BigInt
  /// The time that the session will become idle.
  idle_expires   BigInt
  /// The authenticated user.
  auth_user      AuthUser @relation(references: [id], fields: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@map("Session")
}

/// A authentication method for a user.
model AuthKey {
  /// The ID of the key, will usually contain a key type and value.
  id              String   @id @unique
  /// The encrypted password, if the key supports it.
  hashed_password String?
  /// The ID of the user the key is for.
  user_id         String   @db.Uuid
  /// Whether this is the primary key that cannot be deleted.
  primary_key     Boolean
  /// The date that the key is no longer valid
  expires         BigInt?
  /// The user the key is for.
  auth_user       AuthUser @relation(references: [id], fields: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@map("UserAuthentication")
}

enum SystemRole {
  ADMIN
}

/// A system level role for a user.
model UserSystemRole {
  /// The user with the role.
  user   AuthUser   @relation(fields: [userId], references: [id])
  /// The ID of the user with the role.
  userId String     @db.Uuid
  /// The role given to the user.
  role   SystemRole

  @@id([userId, role])
}

/// A book of the Bible.
model Book {
  /// The ID of the book. Corresponds to its order in the Bible.
  id     Int     @id
  /// The three letter code used to for look ups from references.
  name   String  @unique
  /// The list of verses in the book.
  verses Verse[]
}

/// A verse within a Book of the Bible.
model Verse {
  /// The ID of the verse in the format `BBCCCVVV`.
  id           String             @id
  /// The verse number as it appears in most Bibles.
  number       Int
  /// The chapter number as it appears in most Bibles.
  chapter      Int
  /// The book the verse belongs in.
  book         Book               @relation(fields: [bookId], references: [id])
  /// The ID of the book the verse belongs in.
  bookId       Int
  /// The list of words in the verse.
  words        Word[]
  /// This list of natural translations for this verse.
  translations VerseTranslation[]

  @@unique([bookId, chapter, number])
}

/// A single word within a verse.
model Word {
  /// The ID of the verse in the format `BBCCCVVVWW`. The last two digits are in order as the words appear in the verse.
  id      String    @id
  /// The text in Greek, Hebrew, or Aramaic as it appears in the critical text.
  text    String
  /// The verse the word appears in.
  verse   Verse     @relation(fields: [verseId], references: [id])
  /// The ID of the verse the word appears in.
  verseId String
  /// The specific form of the lemma for the word.
  form    LemmaForm @relation(fields: [formId], references: [id])
  /// The ID of the specific form of the lemma for the word.
  formId  String
  /// The list of glosses in different languages for this word.
  glosses Gloss[]
}

/// A form of a lemma. This are differentiated by grammatical forms, as well as suffixes and prefixes.
model LemmaForm {
  /// The ID of the form in the format `[H|G]<strongs>-<random id>`. Examples: H245-2, G1243-12
  id      String @id
  /// The grammar code for this form.
  grammar String
  /// The lemma that contains this form and its siblings.
  lemma   Lemma  @relation(fields: [lemmaId], references: [id])
  /// The ID of the lemma that contains this form and its siblings.
  lemmaId String
  /// The list of words in verses that share this form of the lemma.
  word    Word[]
}

/// A lemma as defined by strongs numbers.
model Lemma {
  /// The ID of the lemma in the format `[H|G]<strongs>`. Examples: H243, G1243
  id    String      @id
  /// The list of forms of the lemma.
  forms LemmaForm[]
}

/// A language use for translation.
model Language {
  /// The ID of the language. This is distinct from the IETF language code.
  id                String               @id @default(dbgenerated("generate_ulid()")) @db.Uuid
  /// The IETF language code.
  code              String               @unique
  /// The localized name of the language.
  name              String
  /// This list of verse translation in this language.
  verseTranslations VerseTranslation[]
  /// The list of glosses of different words for this language.
  glosses           Gloss[]
  /// The list of roles for members of this language.
  roles             LanguageMemberRole[]
}

enum LanguageRole {
  ADMIN
  TRANSLATOR
  VIEWER
}

/// A role given to a user for a language.
model LanguageMemberRole {
  /// The user who is granted the role for the language.
  user       AuthUser     @relation(fields: [userId], references: [id])
  /// The ID of the user who is granted the role for the language.
  userId     String       @db.Uuid
  /// The language the user is given the role for.
  language   Language     @relation(fields: [languageId], references: [id])
  /// The ID of the language the user is given the role for.
  languageId String       @db.Uuid
  /// The role given to the user for the language.
  role       LanguageRole

  @@id([languageId, userId, role])
}

/// A natural translation for a verse.
model VerseTranslation {
  /// The verse being translated.
  verse       Verse    @relation(fields: [verseId], references: [id])
  /// The ID verse being translated.
  verseId     String
  /// The language of the translation.
  language    Language @relation(fields: [languageId], references: [id])
  /// The ID of the language of the translation.
  languageId  String   @db.Uuid
  /// The text of the translation.
  translation String

  @@id([verseId, languageId])
}

/// A gloss of a word in a particular language.
model Gloss {
  // The word being glossed.
  word       Word     @relation(fields: [wordId], references: [id])
  // The ID of the word being glossed.
  wordId     String
  /// The language of the gloss.
  language   Language @relation(fields: [languageId], references: [id])
  /// The ID of the language of the gloss.
  languageId String   @db.Uuid
  /// The text of the gloss.
  gloss      String?

  @@id([wordId, languageId])
}
